# 移动端 TTS 修复说明

## 问题描述

在移动设备（Android 和 iOS）上，AI 回复的文本转语音功能无法播放声音，即使手动点击播放按钮也不行。

## 根本原因

1. **Web Speech Synthesis API 在移动端的限制**：
   - iOS Safari 和 Android Chrome 对 Web Speech Synthesis API 的支持非常有限
   - 移动浏览器通常阻止自动播放音频
   - 某些移动设备根本不支持 Web Speech Synthesis API

2. **浏览器兼容性问题**：
   - 不同移动浏览器的实现差异很大
   - 事件处理可能不完整
   - 音频播放可能被系统策略阻止

## 解决方案

### 使用后端 TTS API

我们实现了一个后端文本转语音（TTS）服务，使用 Google Text-to-Speech (gTTS) 库生成音频文件，然后在前端播放。这种方法：

- ✅ **跨平台兼容**：在所有移动设备上都能工作
- ✅ **更可靠**：不依赖浏览器的 TTS 实现
- ✅ **更好的音质**：使用专业的 TTS 引擎
- ✅ **用户交互触发**：通过播放按钮触发，符合移动浏览器的策略

### 技术实现

#### 后端实现 (`/api/tts`)

```javascript
// 使用 gtts 库生成 MP3 音频文件
const gtts = require('gtts');
const tts = new gtts(text, 'en');
// 生成音频文件并返回给前端
```

**特点**：
- 使用 Google TTS 引擎（免费，无需 API key）
- 生成 MP3 格式音频
- 自动清理临时文件
- 限制文本长度（最多 1000 字符）防止滥用

#### 前端实现

```javascript
// 调用后端 TTS API
fetch('/api/tts', {
    method: 'POST',
    body: JSON.stringify({ text: text })
})
.then(response => response.blob())
.then(audioBlob => {
    // 创建 Audio 对象并播放
    const audio = new Audio(URL.createObjectURL(audioBlob));
    audio.play();
});
```

**特点**：
- 使用标准的 HTML5 Audio API
- 在所有移动浏览器上都能工作
- 自动清理音频 URL
- 如果后端失败，会回退到 Web Speech Synthesis（桌面浏览器）

## 使用方法

### 自动播放

AI 回复后会自动调用后端 TTS API 生成音频并播放。如果成功，用户会听到声音。

### 手动播放

每个 AI 回复下方都有一个 **"🔊 播放声音"** 按钮：

1. 点击按钮
2. 系统会调用后端 TTS API 生成音频
3. 音频生成后自动播放
4. 播放时按钮显示"⏸️ 播放中..."

## 浏览器兼容性

| 平台/浏览器 | 后端 TTS | Web Speech Synthesis |
|------------|---------|---------------------|
| Chrome (Desktop) | ✅ | ✅ |
| Chrome (Android) | ✅ | ❌ |
| Safari (iOS) | ✅ | ❌ |
| Firefox (Desktop) | ✅ | ✅ |
| Firefox (Android) | ✅ | ❌ |
| Edge (Desktop) | ✅ | ✅ |

## 性能考虑

- **首次播放延迟**：需要生成音频文件，通常 1-3 秒
- **缓存**：每次请求都会生成新的音频文件（不缓存）
- **服务器负载**：每个 TTS 请求都会生成临时文件，但会自动清理

## 依赖项

新增的 npm 包：
- `gtts`: Google Text-to-Speech 库（免费，无需 API key）
- `uuid`: 生成唯一的临时文件名

## 部署注意事项

1. **临时目录**：服务器会在 `temp/` 目录中创建临时音频文件
2. **磁盘空间**：确保服务器有足够的磁盘空间
3. **清理**：临时文件会在使用后自动删除
4. **.gitignore**：`temp/` 目录已添加到 `.gitignore`

## 测试建议

在移动设备上测试：

1. **测试自动播放**：
   - 发送一条消息
   - 等待 AI 回复
   - 检查是否有声音自动播放（可能需要几秒钟生成音频）

2. **测试手动播放**：
   - 如果自动播放失败或想重新播放
   - 点击"🔊 播放声音"按钮
   - 等待音频生成（1-3 秒）
   - 确认声音正常播放

3. **测试多次播放**：
   - 连续发送多条消息
   - 测试每个回复的播放按钮
   - 确认不会互相干扰

## 故障排除

### 如果仍然没有声音

1. **检查网络连接**：TTS API 需要网络请求
2. **检查浏览器控制台**：查看是否有错误信息
3. **检查服务器日志**：查看 TTS 生成是否成功
4. **测试播放按钮**：手动点击播放按钮测试

### 如果音频生成失败

1. **检查服务器日志**：查看 gtts 库的错误信息
2. **检查文本长度**：确保文本不超过 1000 字符
3. **检查磁盘空间**：确保服务器有足够空间

## 更新日志

- **2025-12-30**: 实现后端 TTS API，解决移动端兼容性问题

